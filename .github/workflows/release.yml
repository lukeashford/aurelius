name: Release

on:
  pull_request:
    types: [ opened, synchronize, reopened, edited ]
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  tests:
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run typecheck
      - run: npm run lint
      - run: npm test --if-present

  commitlint:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Lint commits (Conventional Commits)
        run: |
          FROM=${{ github.event.pull_request.base.sha }}
          TO=${{ github.sha }}
          npx commitlint --from "$FROM" --to "$TO" --verbose

  prevent_manual_version_bump:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Ensure package.json version is unchanged (semantic-release owns it)
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          NEW=$(jq -r .version package.json)
          OLD=$(git show origin/${{ github.base_ref }}:package.json | jq -r .version)
          if [ "$NEW" != "$OLD" ]; then
            echo "Do not change version in package.json ($OLD -> $NEW). semantic-release manages this.";
            exit 1;
          else
            echo "OK: package.json version unchanged ($OLD).";
          fi

  release:
    needs: [ tests ]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Semantic release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release
