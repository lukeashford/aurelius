name: Release

on:
  pull_request:
    types: [ opened, synchronize, reopened, edited ]
  push:
    branches: [ main ]

# Needed for semantic-release + npm trusted publishing (OIDC)
permissions:
  contents: write
  id-token: write

jobs:
  tests:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci
      - run: npm run typecheck
      - run: npm run lint
      - run: npm run build

      - name: Pack root package
        id: pack
        run: echo "tarball=$(npm pack)" >> $GITHUB_OUTPUT

      - name: Install demo dependencies
        working-directory: ./demo
        run: npm ci

      - name: Install packed aurelius tarball in demo
        working-directory: ./demo
        run: npm install ../${{ steps.pack.outputs.tarball }} --legacy-peer-deps --no-save

      - name: Run demo unit tests
        working-directory: ./demo
        run: npm test -- --ci --coverage --maxWorkers=2

      - name: Build demo
        working-directory: ./demo
        run: npm run build

      - name: Install Playwright Browsers
        working-directory: ./demo
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        working-directory: ./demo
        env:
          CI: true
        run: npm run test:e2e

  prevent_manual_version_bump:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure package.json version is unchanged (semantic-release owns it)
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          NEW=$(jq -r .version package.json)
          OLD=$(git show origin/${{ github.base_ref }}:package.json | jq -r .version)
          if [ "$NEW" != "$OLD" ]; then
            echo "Do not change version in package.json ($OLD -> $NEW). semantic-release manages this.";
            exit 1;
          else
            echo "OK: package.json version unchanged ($OLD).";
          fi

  release:
    needs: [ tests ]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    # Explicitly grant what release needs (includes OIDC minting)
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
          registry-url: https://registry.npmjs.org

      - run: npm ci

      - name: Semantic release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
